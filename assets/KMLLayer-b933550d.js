import{u as J,e as i,y as n,a as C}from"./jsonMap-ffa742d3.js";import"./geometry-7d866d3f.js";import{j as F}from"./Collection-74ae958a.js";import{l as U}from"./CollectionFlattener-80d223f1.js";import{r as w}from"./typedArrayUtil-bf9f210a.js";import{O as W}from"./MultiOriginJSONSupport-06f8f24a.js";import{w as q}from"./promiseUtils-5940888c.js";import{a as L,U as k,l as R,j as _}from"./reactiveUtils-53e5756b.js";import{r as M,E as A,U as D,q as H}from"./request-09e7d9b2.js";import{b as V}from"./ArrayPool-b51874dd.js";import{f as G,e as I,o as P,r as B}from"./Extent-22afa84a.js";import{b as Q}from"./Layer-524734fa.js";import{n as X}from"./BlendLayer-793ff14a.js";import{c as Y,f as Z}from"./OperationalLayer-db187f46.js";import{_ as ee}from"./PortalLayer-d69e402d.js";import{p as te}from"./RefreshableLayer-12bc7ba2.js";import{t as re}from"./ScaleRangeLayer-d1b04b80.js";import{n as oe}from"./Evented-686173eb.js";import{m as ie}from"./Loadable-40ecd3b9.js";import{p as v,u as se}from"./string-53224faa.js";import{b as le}from"./Error-5cdd6e0a.js";import"./PopupTemplate-81dc9b83.js";import{a as j,D as x,f as g,k as ne}from"./aaBoundingBox-fb003858.js";import{k as S}from"./Polyline-82cb63bc.js";import"./jsonUtils-9b4d797d.js";import"./FeatureSet-b4fbf079.js";import"./nextTick-3ee5a785.js";import"./typeUtils-1714017f.js";import"./SimpleObservable-bd2c3ae8.js";import"./preload-helper-41c905a7.js";import"./Ellipsoid-89682c5e.js";import"./Identifiable-e4f9b04c.js";import"./colorUtils-639f4d25.js";import"./screenUtils-410d12c0.js";import"./mat4f32-60a2394b.js";import"./mat4-f0dc8788.js";import"./vec3-8818fe1c.js";import"./common-d0b63c2d.js";import"./TimeExtent-64e16588.js";import"./persistableUrlUtils-3635dccc.js";import"./ElevationInfo-005ddd87.js";import"./fieldUtils-d430f46c.js";import"./arcadeOnDemand-dd48afd7.js";import"./lengthUtils-3c9047c4.js";import"./opacityUtils-d4a4b602.js";import"./asyncUtils-24bd37b2.js";import"./layerUtils-eef15b39.js";import"./Portal-8dfa7a94.js";import"./locale-fe7cc1d0.js";import"./PortalGroup-00fb77a4.js";import"./PortalUser-9579f611.js";import"./PortalItem-4d7e1038.js";import"./assets-94d592bf.js";import"./Promise-755e47e5.js";import"./portalItemUtils-0655aa33.js";import"./projection-4ac247db.js";import"./mathUtils-ae09f98b.js";import"./vec4-c7a19f0d.js";import"./aaBoundingRect-2fb32e32.js";import"./zscale-baa108ea.js";import"./Clonable-7fa7ad97.js";import"./enumeration-925aa0f6.js";import"./number-036ac4ef.js";import"./UniqueValueRenderer-80c8e628.js";import"./symbols-5f42cb0e.js";import"./CIMSymbol-8f55d4ab.js";import"./Color-7b46c33a.js";import"./symbolLayerUtils3D-5cf2dcce.js";import"./Symbol3DAnchorPosition2D-e9d8a8f4.js";import"./collectionUtils-423a192d.js";import"./ColorStop-29c89bbb.js";import"./diffUtils-1bae97a1.js";import"./colorRamps-18bbdf60.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-61985981.js";import"./Graphic-5dcfa25e.js";import"./jsonUtils-36bf3d33.js";import"./compilerUtils-7bf6df9e.js";import"./jsonUtils-27937179.js";import"./styleUtils-689841ac.js";import"./DictionaryLoader-1c3435ac.js";import"./LRUCache-86d9ad15.js";import"./MemCache-b4d68123.js";import"./deprecate-ba25fc78.js";import"./heatmapUtils-8ee685fd.js";import"./vec4f64-6d0e93be.js";import"./Field-945b2973.js";import"./fieldType-24ac97df.js";const ae={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function T(e){const t=e.folders||[],o=t.slice(),r=new Map,s=new Map,h=new Map,d=new Map,c=new Map,m={esriGeometryPoint:s,esriGeometryPolyline:h,esriGeometryPolygon:d};(e.featureCollection&&e.featureCollection.layers||[]).forEach(l=>{const p=v(l);p.featureSet.features=[];const y=l.featureSet.geometryType;r.set(y,p);const E=l.layerDefinition.objectIdField;y==="esriGeometryPoint"?$(s,E,l.featureSet.features):y==="esriGeometryPolyline"?$(h,E,l.featureSet.features):y==="esriGeometryPolygon"&&$(d,E,l.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(l=>{c.set(l.id,l)}),t.forEach(l=>{l.networkLinkIds.forEach(p=>{const y=ue(p,l.id,e.networkLinks);y&&o.push(y)})}),o.forEach(l=>{if(l.featureInfos){l.points=v(r.get("esriGeometryPoint")),l.polylines=v(r.get("esriGeometryPolyline")),l.polygons=v(r.get("esriGeometryPolygon")),l.mapImages=[];for(const p of l.featureInfos)switch(p.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const y=m[p.type].get(p.id);y&&l[ae[p.type]].featureSet.features.push(y);break}case"GroundOverlay":{const y=c.get(p.id);y&&l.mapImages.push(y);break}}l.fullExtent=O([l])}});const f=O(o);return{folders:t,sublayers:o,extent:f}}function N(e,t,o,r){const s=M&&M.findCredential(e);e=A(e,{token:s&&s.token});const h=le.kmlServiceUrl;return D(h,{query:{url:e,model:"simple",folders:"",refresh:o!==0||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:r})}function K(e,t,o=null,r=[]){const s=[],h={},d=t.sublayers,c=t.folders.map(m=>m.id);return d.forEach(m=>{var l;const f=new e;if(o?f.read(m,o):f.read(m),r.length&&c.includes(f.id)&&(f.visible=r.includes(f.id)),h[m.id]=f,m.parentFolderId!=null&&m.parentFolderId!==-1){const p=h[m.parentFolderId];p.sublayers||(p.sublayers=[]),(l=p.sublayers)==null||l.unshift(f)}else s.unshift(f)}),s}function $(e,t,o){o.forEach(r=>{e.set(r.attributes[t],r)})}function pe(e,t){let o;return t.some(r=>r.id===e&&(o=r,!0)),o}function ue(e,t,o){const r=pe(e,o);return r&&(r.parentFolderId=t,r.networkLink=r),r}function O(e){const t=j(x),o=j(x);for(const r of e){if(r.polygons&&r.polygons.featureSet&&r.polygons.featureSet.features)for(const s of r.polygons.featureSet.features)S(t,s.geometry),g(o,t);if(r.polylines&&r.polylines.featureSet&&r.polylines.featureSet.features)for(const s of r.polylines.featureSet.features)S(t,s.geometry),g(o,t);if(r.points&&r.points.featureSet&&r.points.featureSet.features)for(const s of r.points.featureSet.features)S(t,s.geometry),g(o,t);if(r.mapImages)for(const s of r.mapImages)S(t,s.extent),g(o,t)}return ne(o,x)?void 0:{xmin:o[0],ymin:o[1],zmin:o[2],xmax:o[3],ymax:o[4],zmax:o[5],spatialReference:G.WGS84}}var b;let u=b=class extends oe.EventedMixin(J(ie)){constructor(...e){super(...e),this.description=null,this.id=null,this.networkLink=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.fullExtent=null,this.addHandles([L(()=>this.sublayers,"after-add",({item:t})=>{t.parent=this,t.layer=this.layer},k),L(()=>this.sublayers,"after-remove",({item:t})=>{t.layer=t.parent=null},k),R(()=>this.sublayers,(t,o)=>{if(o)for(const r of o)r.layer=r.parent=null;if(t)for(const r of t)r.parent=this,r.layer=this.layer},k)])}initialize(){_(()=>this.networkLink).then(()=>_(()=>this.visible===!0)).then(()=>this.load())}load(e){var r;if(!this.networkLink||this.networkLink.viewFormat)return;const t=w(e)?e.signal:null,o=this._fetchService(((r=this._get("networkLink"))==null?void 0:r.href)??"",t).then(s=>{var c;const h=O(s.sublayers);this.fullExtent=I.fromJSON(h),this.sourceJSON=s;const d=V(F.ofType(b),K(b,s));this.sublayers?this.sublayers.addMany(d):this.sublayers=d,(c=this.layer)==null||c.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")});return this.addResolvingPromise(o),Promise.resolve(this)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,t){return!!t.visibility}set layer(e){this._set("layer",e),this.sublayers&&this.sublayers.forEach(t=>t.layer=e)}_fetchService(e,t){return N(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(o=>T(o.data))}};i([n()],u.prototype,"description",void 0),i([n()],u.prototype,"id",void 0),i([n({readOnly:!0,value:null})],u.prototype,"networkLink",void 0),i([n({json:{write:{allowNull:!0}}})],u.prototype,"parent",void 0),i([n({type:F.ofType(b),json:{write:{allowNull:!0}}})],u.prototype,"sublayers",void 0),i([n({value:null,json:{read:{source:"name",reader:e=>se(e)}}})],u.prototype,"title",void 0),i([n({value:!0})],u.prototype,"visible",null),i([P("visible",["visibility"])],u.prototype,"readVisible",null),i([n()],u.prototype,"sourceJSON",void 0),i([n({value:null})],u.prototype,"layer",null),i([n({type:I})],u.prototype,"fullExtent",void 0),u=b=i([C("esri.layers.support.KMLSublayer")],u);const z=u,ye=["kml","xml"];let a=class extends X(te(re(Y(ee(W(Q)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new U({getCollections:()=>[this.sublayers],getChildrenFunction:t=>t.sublayers}),this.outSpatialReference=G.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType="KML",this.sublayers=null,this.type="kml",this.url=null}initialize(){this.addHandles([R(()=>this.sublayers,(e,t)=>{t&&t.forEach(o=>{o.parent=null,o.layer=null}),e&&e.forEach(o=>{o.parent=this,o.layer=this})},k),this.on("sublayer-update",()=>this.notifyChange("fullExtent"))])}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,o){return K(z,t,o,this._visibleFolders)}writeSublayers(e,t){const o=[],r=e.toArray();for(;r.length;){const s=r[0];s.networkLink||(s.visible&&o.push(s.id),s.sublayers&&r.push(...s.sublayers.toArray())),r.shift()}t.visibleFolders=o}get title(){const e=this._get("title");return e&&this.originOf("title")!=="defaults"?e:this.url?H(this.url,ye)||"KML":e||""}set title(e){this._set("title",e)}get visibleSublayers(){const e=this.sublayers,t=[],o=r=>{r.visible&&(t.push(r),r.sublayers&&r.sublayers.forEach(o))};return e&&e.forEach(o),t}get fullExtent(){return this._recomputeFullExtent()}load(e){const t=w(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"],supportsData:!1},e).catch(q).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){const t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:N(this.url??"",this.outSpatialReference,this.refreshInterval,e)),o=T(t.data);o&&this.read(o,{origin:"service"})}_recomputeFullExtent(){let e=null;w(this.extent)&&(e=this.extent.clone());const t=o=>{if(o.sublayers)for(const r of o.sublayers.items)t(r),r.visible&&r.fullExtent&&(w(e)?e.union(r.fullExtent):e=r.fullExtent.clone())};return t(this),e}};i([n({readOnly:!0})],a.prototype,"allSublayers",void 0),i([n({type:G})],a.prototype,"outSpatialReference",void 0),i([n({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],a.prototype,"path",void 0),i([n({readOnly:!0,json:{read:!1,write:!1}})],a.prototype,"legendEnabled",void 0),i([n({type:["show","hide","hide-children"]})],a.prototype,"listMode",void 0),i([n({type:["KML"]})],a.prototype,"operationalLayerType",void 0),i([n({})],a.prototype,"resourceInfo",void 0),i([n({type:F.ofType(z),json:{write:{ignoreOrigin:!0}}})],a.prototype,"sublayers",void 0),i([P(["web-map","portal-item"],"sublayers",["visibleFolders"])],a.prototype,"readSublayersFromItemOrWebMap",null),i([P("service","sublayers",["sublayers"])],a.prototype,"readSublayers",null),i([B("sublayers")],a.prototype,"writeSublayers",null),i([n({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0),i([n({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}}})],a.prototype,"title",null),i([n(Z)],a.prototype,"url",void 0),i([n({readOnly:!0})],a.prototype,"visibleSublayers",null),i([n({type:I})],a.prototype,"extent",void 0),i([n()],a.prototype,"fullExtent",null),a=i([C("esri.layers.KMLLayer")],a);const Dt=a;export{Dt as default};
