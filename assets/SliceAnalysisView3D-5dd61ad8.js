import{l as Xt,e as c,y as u,s as Je,a as de,v as je,t as $e,A as Jt}from"./jsonMap-ffa742d3.js";import{L as Qt,e as Tt,r as h,t as g,y as Qe,a as W,p as et}from"./typedArrayUtil-bf9f210a.js";import{a as tt}from"./ArrayPool-b51874dd.js";import{n as ei,g as ti,c as ii,a as ai,b as si}from"./LineVisualElement-4382615e.js";import"./geometry-7d866d3f.js";import{i as ni}from"./Clonable-7fa7ad97.js";import{s as it}from"./Cyclical-47bda305.js";import{g as le}from"./persistable-227af340.js";import{w as ri}from"./Extent-22afa84a.js";import{s as Et}from"./Error-5cdd6e0a.js";import{l as I,U as oi,w as He}from"./reactiveUtils-53e5756b.js";import{a4 as li,a5 as hi,Y as ci,aU as De,bh as Ne,bi as di,bj as ui,b5 as Ct,aV as ce,aW as U,M as Dt,bk as $,bl as ze,b6 as ye,bm as Me,bn as pi,aJ as gi,bo as at,bp as _i,x as yi,h as wi,bg as he,bq as V,b4 as vi,aH as mi}from"./SceneView-7ac05f56.js";import{b as st}from"./Layer-524734fa.js";import{M as fi}from"./BuildingComponentSublayer-f2558dc9.js";import{h as Pi}from"./string-53224faa.js";import{m as Te,b as bi}from"./mathUtils-ae09f98b.js";import{p as Ge,c as Vi,d as nt,i as $i}from"./screenUtils-410d12c0.js";import{x as Mi,R as Ke,f as Ot,c as Z,l as St,r as rt,i as ot,A as lt,p as Ti,g as It}from"./mat4-f0dc8788.js";import{e as Se}from"./mat4f64-abdda1bb.js";import{Q as ht}from"./quat-77a0169c.js";import{r as N,g as w,a as R,P as x,_ as F,z as D,u as m,s as M,e as A,t as Rt,o as se,v as Ei,n as X,O as ct}from"./vec3-8818fe1c.js";import{i as Ci}from"./projection-4ac247db.js";import{d as xt,c as l,e as L,i as Di,n as dt,o as ut,t as Oi}from"./sphere-a48b65b1.js";import{O as Lt,_ as At,V as pt,p as Ue,x as be,Y as Si}from"./plane-01584357.js";import{e as ue,r as J,l as Ii}from"./vec4f64-6d0e93be.js";import{V as Ri,i as kt,e as H,U as xi,x as Li,c as Ai,a as we,C as ki,s as Hi,m as Ni}from"./analysisViewUtils-61ca3438.js";import{a as gt}from"./vec4-c7a19f0d.js";import{E as zi,g as C}from"./VisualVariablePassParameters-f892560d.js";import{h as Gi}from"./Matrix3PassUniform-df6e2166.js";import{t as Ui}from"./ShaderTechniqueConfiguration-0fa0f78c.js";import{B as Fi,E as Wi,d as Bi}from"./objectResourceUtils-3685cb27.js";import{_ as ji}from"./preload-helper-41c905a7.js";import{o as Ki,a as _t,n as qi}from"./ShaderBuilder-be7ca791.js";import{t as Yi,e as Zi,o as Xi,W as Ji,l as Qi,_ as ea}from"./EvaluateSceneLighting.glsl-14c608ff.js";import{v as ta}from"./View.glsl-879c1eaf.js";import{e as yt}from"./Float4PassUniform-9354414b.js";import{o as ia}from"./FloatPassUniform-0426669b.js";import{O as wt}from"./VertexAttribute-15d1866a.js";import{R as ve,I as aa}from"./enums-fc527c7c.js";import{n as me}from"./basicInterfaces-7449a8bf.js";import{n as sa}from"./compilerUtils-7bf6df9e.js";import{t as na}from"./promiseUtils-5940888c.js";import{o as ra,i as oa,C as fe}from"./Factory-3a66d8bc.js";let k=class extends ni(Xt){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&Qt(this.position,t.position)&&this.width===t.width&&this.height===t.height}};c([u({readOnly:!0,json:{read:!1,write:!0}})],k.prototype,"type",void 0),c([u({type:ri}),le()],k.prototype,"position",void 0),c([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),le(),Je(e=>it.normalize(tt(e),0,!0))],k.prototype,"heading",void 0),c([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),le(),Je(e=>it.normalize(tt(e),0,!0))],k.prototype,"tilt",void 0),c([u({type:Number,nonNullable:!0}),le()],k.prototype,"width",void 0),c([u({type:Number,nonNullable:!0}),le()],k.prototype,"height",void 0),k=c([de("esri.analysis.SlicePlane")],k);const qe=k,Ie=Pi("mac")?"Meta":"Control",Re="Shift",la=2,ha=1.15,ca=1.15,da=2500,ua=.02,pa=Math.cos(Te(45)),vt=Math.cos(Te(5)),ga=.95,_a=.3,ya=.7,pe=N(1,.5,0),Ht=2,Nt=1,ie=ue([...pe,ya]),ae=[0,0,0,.04],zt=ue([...pe,.5]),wa=J(1,1,1,1),va=J(1,.8,.6,1),ma=J(1,.93,.86,1),fa=ue([...pe,1]),Pa=ue([...pe,1]),ba=3,Gt=11,Fe=22.5,Ve=40,mt=48,Va=2.25,$a=ue([...pe,1]),Ma=4,ft=1,Ta=.3,Ea=6,Ca=4,Pt=1600,Da=.4;function Oa(e){const t=new Ki;t.extensions.add("GL_OES_standard_derivatives");const{vertex:i,fragment:a,attributes:s,varyings:r}=t;return ta(i,e),s.add(wt.POSITION,"vec3"),s.add(wt.UV0,"vec2"),r.add("vUV","vec2"),i.code.add(_t`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add([new yt("backgroundColor",n=>n.backgroundColor),new yt("gridColor",n=>n.gridColor),new ia("gridWidth",n=>n.gridWidth)]),a.code.add(_t`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const Sa=Object.freeze(Object.defineProperty({__proto__:null,build:Oa},Symbol.toStringTag,{value:"Module"}));let Ia=class extends qi{constructor(){super(...arguments),this.backgroundColor=J(1,0,0,.5),this.gridColor=J(0,1,0,.5),this.gridWidth=4}},Ut=class Ft extends Zi{initializeProgram(t){return new Xi(t.rctx,Ft.shader.get().build(this.configuration),zi)}initializePipeline(){return Ji({blending:Qi(ve.ONE,ve.ONE,ve.ONE_MINUS_SRC_ALPHA,ve.ONE_MINUS_SRC_ALPHA),depthTest:{func:aa.LESS},colorWrite:ea})}};Ut.shader=new Yi(Sa,()=>ji(()=>import("./SlicePlaneMaterial.glsl-c1a5344f.js"),["./SlicePlaneMaterial.glsl-c1a5344f.js","./View.glsl-879c1eaf.js","./mat4-f0dc8788.js","./vec3-8818fe1c.js","./common-d0b63c2d.js","./mat4f32-60a2394b.js","./ShaderBuilder-be7ca791.js","./typedArrayUtil-bf9f210a.js","./Error-5cdd6e0a.js","./string-53224faa.js","./VertexAttribute-15d1866a.js","./jsonMap-ffa742d3.js","./ArrayPool-b51874dd.js","./nextTick-3ee5a785.js","./promiseUtils-5940888c.js","./LineVisualElement-4382615e.js","./Promise-755e47e5.js","./projection-4ac247db.js","./preload-helper-41c905a7.js","./mathUtils-ae09f98b.js","./vec4-c7a19f0d.js","./Extent-22afa84a.js","./Ellipsoid-89682c5e.js","./SimpleObservable-bd2c3ae8.js","./Polyline-82cb63bc.js","./assets-94d592bf.js","./request-09e7d9b2.js","./aaBoundingRect-2fb32e32.js","./zscale-baa108ea.js","./SceneView-7ac05f56.js","./Clonable-7fa7ad97.js","./Cyclical-47bda305.js","./geometry-7d866d3f.js","./typeUtils-1714017f.js","./Graphic-5dcfa25e.js","./PopupTemplate-81dc9b83.js","./Collection-74ae958a.js","./Evented-686173eb.js","./fieldUtils-d430f46c.js","./arcadeOnDemand-dd48afd7.js","./enumeration-925aa0f6.js","./number-036ac4ef.js","./locale-fe7cc1d0.js","./Identifiable-e4f9b04c.js","./symbols-5f42cb0e.js","./CIMSymbol-8f55d4ab.js","./Color-7b46c33a.js","./colorUtils-639f4d25.js","./screenUtils-410d12c0.js","./opacityUtils-d4a4b602.js","./symbolLayerUtils3D-5cf2dcce.js","./aaBoundingBox-fb003858.js","./persistableUrlUtils-3635dccc.js","./Symbol3DAnchorPosition2D-e9d8a8f4.js","./collectionUtils-423a192d.js","./Portal-8dfa7a94.js","./Loadable-40ecd3b9.js","./PortalGroup-00fb77a4.js","./PortalUser-9579f611.js","./jsonUtils-36bf3d33.js","./widget-01c21b51.js","./intl-87d72dbe.js","./messages-1516d146.js","./reactiveUtils-53e5756b.js","./uuid-73213768.js","./workers-c8fc8d43.js","./Connection-3d9fb42e.js","./GraphicsLayer-cbd6e467.js","./HandleOwner-6217a02e.js","./Layer-524734fa.js","./BlendLayer-793ff14a.js","./ScaleRangeLayer-d1b04b80.js","./ElevationInfo-005ddd87.js","./lengthUtils-3c9047c4.js","./HeightModelInfo-73f516f9.js","./sphere-a48b65b1.js","./vec4f64-6d0e93be.js","./byteSizeEstimations-f0cab514.js","./mat3f64-50f3b9f6.js","./mat4f64-abdda1bb.js","./quatf64-f8f1c132.js","./vec2f64-70cfd09e.js","./lineSegment-4eb8b6fa.js","./plane-01584357.js","./spatialReferenceEllipsoidUtils-88aa82c4.js","./scaleUtils-a3b834c2.js","./layerUtils-eef15b39.js","./AttachmentInfo-23249301.js","./AttachmentQuery-f1085685.js","./ColorStop-29c89bbb.js","./utils-6a5cc1bf.js","./asyncUtils-24bd37b2.js","./ItemCache-e927309e.js","./MemCache-b4d68123.js","./jsonUtils-9b4d797d.js","./UniqueValueRenderer-80c8e628.js","./diffUtils-1bae97a1.js","./colorRamps-18bbdf60.js","./sizeVariableUtils-d4870b0d.js","./visualVariableUtils-61985981.js","./compilerUtils-7bf6df9e.js","./jsonUtils-27937179.js","./styleUtils-689841ac.js","./DictionaryLoader-1c3435ac.js","./LRUCache-86d9ad15.js","./deprecate-ba25fc78.js","./heatmapUtils-8ee685fd.js","./Query-b0193ce7.js","./TimeExtent-64e16588.js","./Field-945b2973.js","./fieldType-24ac97df.js","./executeQueryJSON-044ac84b.js","./normalizeUtils-353ec0fc.js","./normalizeUtilsCommon-d8ea404e.js","./query-b4dff312.js","./pbfQueryUtils-481b10bc.js","./pbf-845dcafd.js","./OptimizedFeature-3e582950.js","./OptimizedFeatureSet-1d1ac4b9.js","./queryZScale-f6e44ca7.js","./FeatureSet-b4fbf079.js","./featureConversionUtils-aead6959.js","./RelationshipQuery-765b2184.js","./TopFeaturesQuery-d2b31d08.js","./FeatureLayer-e767d294.js","./MultiOriginJSONSupport-06f8f24a.js","./serviceCapabilitiesUtils-22f436bd.js","./arcgisLayerUrl-1b8d6c52.js","./FeatureLayerBase-633118ca.js","./OperationalLayer-db187f46.js","./TimeReference-adaa7961.js","./datetime-eed49b9b.js","./editsZScale-9d0832b8.js","./APIKeyMixin-ef4ccb38.js","./ArcGISService-24587a68.js","./CustomParametersMixin-2798ec18.js","./EditBusLayer-b1010019.js","./FeatureReductionLayer-5ef01ce2.js","./labelingInfo-e65ecbf4.js","./labelUtils-b68da70f.js","./defaultsJSON-59981e75.js","./OrderedLayer-045186a6.js","./PortalLayer-d69e402d.js","./PortalItem-4d7e1038.js","./portalItemUtils-0655aa33.js","./RefreshableLayer-12bc7ba2.js","./TemporalLayer-f231f22a.js","./FeatureTemplate-5a472038.js","./FeatureType-017f886c.js","./fieldProperties-7a0757a8.js","./FieldsIndex-113320d3.js","./versionUtils-9a1e7983.js","./styleUtils-5c617777.js","./popupUtils-b8625101.js","./callExpressionWithFeature-eb5719d8.js","./quantizationUtils-16db4e0b.js","./Scheduler-61737382.js","./ElevationSamplerData-3fc2a90f.js","./TileInfo-9973cd47.js","./Basemap-5a7c72ee.js","./loadAll-8ca49458.js","./writeUtils-b7104d82.js","./CollectionFlattener-80d223f1.js","./TablesMixin-8f62a14c.js","./ViewingMode-5d7d590b.js","./vec2-848c6cf0.js","./PhysicallyBasedRendering.glsl-edd81ba9.js","./FloatPassUniform-0426669b.js","./Float4PassUniform-9354414b.js","./RgbaFloatEncoding.glsl-67199794.js","./Texture2DPassUniform-268e8d2d.js","./vec3f32-01c06d8d.js","./Texture2DDrawUniform-e4341b84.js","./basicInterfaces-7449a8bf.js","./PiUtils.glsl-49462ceb.js","./ReadLinearDepth.glsl-0e6f5c47.js","./WaterSurface.glsl-e13d44e2.js","./ForwardLinearDepth.glsl-52bf5bdc.js","./Matrix3PassUniform-df6e2166.js","./Slice.glsl-cd30f0ea.js","./Transform.glsl-052069d0.js","./OutputHighlight.glsl-ca02d1ee.js","./MultipassTerrainTest.glsl-8b279fcd.js","./NormalUtils.glsl-84d184a7.js","./AlphaCutoff-96178e0d.js","./TransparencyPassType-c3841b0a.js","./EvaluateSceneLighting.glsl-14c608ff.js","./VisualVariablePassParameters-f892560d.js","./enums-fc527c7c.js","./VertexElementDescriptor-2925c6af.js","./Texture-d2fa6cd8.js","./context-util-34d303b7.js","./Util-513876a8.js","./SSAOBlur.glsl-c56632c0.js","./ScreenSpacePass.glsl-44cc0c5e.js","./SSAO.glsl-2c6533cd.js","./ShaderTechniqueConfiguration-0fa0f78c.js","./mat3-4fd89d48.js","./HUD.glsl-73b068b4.js","./VerticalOffset.glsl-109e8746.js","./Octree-813f29c9.js","./objectResourceUtils-3685cb27.js","./devEnvironmentUtils-5002a058.js","./BufferView-b402c7a7.js","./vec33-ca555933.js","./DefaultMaterial_COLOR_GAMMA-8ec4380b.js","./types-e1c0a5bf.js","./Version-621cc6b7.js","./quat-77a0169c.js","./resourceUtils-527631ac.js","./Indices-f9b34f39.js","./DefaultMaterial.glsl-58ca0075.js","./MixExternalColor.glsl-f5c601ed.js","./symbolColorUtils-1c63720c.js","./ObjectAndLayerIdColor.glsl-66083f64.js","./OutputDepth.glsl-17bf0574.js","./VisualVariables.glsl-bb97d5ba.js","./DiscardOrAdjustAlphaBlend.glsl-27f02ebd.js","./VertexColor.glsl-2f905a78.js","./Normals.glsl-6a1bc6fb.js","./vec2f32-eaf29605.js","./Texture-ae652f15.js","./TextureOnly.glsl-469cc321.js","./Attribute-f72d3f37.js","./InterleavedLayout-07cc6753.js","./DefaultTechniqueConfiguration-b54ae0b1.js","./RealisticTree.glsl-29f7cbd7.js","./edgeProcessing-ac701714.js","./deduplicate-a70aec6f.js","./MeshComponent-777de3ff.js","./earcut-61f7b102.js","./projection-03824933.js","./HUDMaterial.glsl-82200888.js","./sdfPrimitives-3ceeab79.js","./floatRGBA-1f66d0a4.js","./dehydratedFeatures-efdbcd90.js","./labelFormatUtils-f90ee62f.js","./orientedBoundingBox-6188c4d9.js","./quatf32-51a323b8.js","./LineCallout.glsl-76cd336e.js","./SnappingCandidate-970faec6.js","./MarkerSizing.glsl-950a18f6.js","./RibbonLine.glsl-8fe4662b.js","./LineStipple.glsl-4eef2aea.js","./LineMarker.glsl-2c017de2.js","./NativeLine.glsl-9893bc56.js","./Path.glsl-2eb74a31.js","./ColorMaterial.glsl-1d45c81e.js","./Pattern.glsl-698f2083.js","./LercDecoder-f1486af7.js","./enums-fb086c25.js","./config-f7904f35.js","./TileKey-4d1284e4.js","./workerHelper-2d7b0d57.js","./capabilities-caaa1278.js","./SceneView-292eb7eb.css","./persistable-227af340.js","./multiOriginJSONSupportUtils-c978f4c3.js","./resourceExtension-3dd2f93a.js","./BuildingComponentSublayer-f2558dc9.js","./capabilities-a18453f6.js","./I3SIndexInfo-1765b03c.js","./I3SLayerDefinitions-7bfc1943.js","./I3SUtil-4be1431c.js","./I3SBinaryReader-1333d96d.js","./popupUtils-55b97964.js","./analysisViewUtils-61ca3438.js","./ImageMaterial-771bdfd8.js","./ImageMaterial.glsl-2e22ba6f.js","./Factory-3a66d8bc.js"],import.meta.url));class Ra extends li{constructor(t){super(t,new La),this._configuration=new Ui}createBufferWriter(){return new Fi(hi)}requiresSlot(t,i){return i===Gi.Color&&t===Wi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return new xa(t)}getConfiguration(){return this._configuration}}class xa extends Bi{constructor(t){super(t),this.ensureTechnique(Ut,null)}beginSlot(){return Tt(this.technique)}}class La extends Ia{constructor(){super(...arguments),this.renderOccluded=C.Occlude}}class Aa extends ei{constructor(t){super(t),this._material=null,this._renderOccluded=C.OccludeAndTransparent,this._gridWidth=1,this._gridColor=J(1,0,0,1),this._backgroundColor=J(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){gt(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){gt(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Ra(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){h(this._material)&&t(this._material)}createGeometries(t){if(h(this._material)){const i=ci(this._material);t.addGeometry(i)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){h(this._material)&&this._material.setParameters(this._materialParameters)}}function ka(e,t,i,a,s,r,n,o){return Ha(t,n.worldUpAtPosition(e,l.get()),s,r,o.basis1,o.basis2),w(o.basis1,o.basis1,i),w(o.basis2,o.basis2,a),R(o.origin,e),Lt(o.basis2,o.basis1,o.origin,o.plane),o}function Ha(e,t,i,a,s,r){const n=x(e,t),o=l.get(),d=l.get();switch(a===T.HORIZONTAL_OR_VERTICAL?Math.abs(n)>pa?T.HORIZONTAL:T.VERTICAL:a){case T.VERTICAL:{const p=Math.abs(n)<=vt?e:i.viewUp;F(o,p,t),R(d,t);break}case T.HORIZONTAL:F(o,i.viewUp,t),F(d,t,o);break;case T.TILTED:{const p=Math.abs(n)<=vt?t:i.viewUp;F(o,p,e),F(d,e,o);break}}const y=F(l.get(),o,d);x(y,i.viewForward)>0&&w(d,d,-1),D(s,o),D(r,d)}function Na(e,t,i){const a=t.worldUpAtPosition(e.origin,l.get()),s=e.basis1,r=Xe(e,a),n=Math.round(r/re)*re;return ze(e,n-r,s,i)}function za(e,t,i,a,s,r){const n=R(l.get(),s.origin);m(n,n,w(l.get(),s.basis1,e.direction[0]<0?1:-1)),m(n,n,w(l.get(),s.basis2,e.direction[1]<0?1:-1));const o=M(s.basis1),d=M(s.basis2),y=A(l.get(),i,n),p=A(l.get(),t,n);let _=0,v=0;if(Ze(e)){const ge=We(s),j=We(r);_=o-.5*e.direction[0]*x(s.basis1,p)/o,v=d-.5*e.direction[1]*x(s.basis2,p)/d;const ee=j/ge;_*=ee,v*=ee}const O=_+.5*e.direction[0]*x(s.basis1,y)/o,E=v+.5*e.direction[1]*x(s.basis2,y)/d,Q=w(l.get(),s.basis1,O/o),B=w(l.get(),s.basis2,E/d);(O<=0||Vt(r.origin,Q,a)<=Pt)&&R(Q,r.basis1),(E<=0||Vt(r.origin,B,a)<=Pt)&&R(B,r.basis2);const b=R(l.get(),n);return m(b,b,w(l.get(),Q,e.direction[0]<0?-1:1)),m(b,b,w(l.get(),B,e.direction[1]<0?-1:1)),Ne(b,Q,B,r)}function Ga(e,t){return Da*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Ua(e,t,i,a){const s=F(l.get(),t,i);return F(s,s,t),At(e,s,a)}function Wt(e,t){return Ri(e.basis1,e.basis2,e.origin,t)}function bt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,l.get()),r=l.get();switch(i){case ne.HEADING:R(r,s);break;case ne.TILT:R(r,e.basis1)}return At(e.origin,r,a)}function Fa(e,t,i,a){const s=Ye(i,z.NEGATIVE_X),r=L.get();Mi(r,t,s.edge*Math.PI/2);const n=D(l.get(),s.basis);let o=w(l.get(),n,s.direction*a.computeScreenPixelSizeAt(s.position)*Ve);m(o,o,s.position);const d=a.projectToRenderScreen(o,Ge(l.get())),y=Wa(a,d);di(a,d,Pe),D(Pe.direction,Pe.direction);const p=l.get();!y&&ui(i,Pe,p)&&(o=p),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=Rt(o),y?e.state|=Ee:e.state&=~Ee}function Wa(e,t){const[i,a,s,r]=e.viewport,n=Math.min(s,r)/16;let o=!0;return t[0]<i+n?(t[0]=i+n,o=!1):t[0]>i+s-n&&(t[0]=i+s-n,o=!1),t[1]<a+n?(t[1]=a+n,o=!1):t[1]>a+r-n&&(t[1]=a+r-n,o=!1),o}function Ba(e,t,i,a){const s=M(a.basis1),r=M(a.basis2),n=Bt(a),o=We(a),d=se(l.get(),0,0,0);m(d,w(l.get(),a.basis1,t.direction[0]),w(l.get(),a.basis2,t.direction[1])),m(d,a.origin,d);let y=0,p=1;if(Ze(t))t.direction[0]===1&&t.direction[1]===-1?y=re:t.direction[0]===1&&t.direction[1]===1?y=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(y=3*Math.PI/2),p=o;else{const v=t.direction[0]!==0?1:2;y=v===1?re:0,p=(v===1?r:s)-n}const _=Ke(L.get(),y);Ot(_,_,se(l.get(),p,p,p)),Z(_,i,_),_[12]=0,_[13]=0,_[14]=0,e.modelTransform=_,e.renderLocation=d}function ja(e,t,i,a){const s=a.worldUpAtPosition(i.origin,l.get()),r=Ye(i,z.POSITIVE_X),n=Ke(L.get(),r.edge*Math.PI/2);St(n,n,-Xe(i,s)),Z(n,t,n),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=r.position}function Ka(e,t,i){const a=Ye(i,z.POSITIVE_Y),s=Ke(L.get(),a.edge*Math.PI/2);St(s,s,re),Z(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var z;function Ye(e,t){switch(t){case z.POSITIVE_X:return{basis:e.basis1,direction:1,position:m(l.get(),e.origin,e.basis1),edge:t};case z.POSITIVE_Y:return{basis:e.basis2,direction:1,position:m(l.get(),e.origin,e.basis2),edge:t};case z.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:A(l.get(),e.origin,e.basis1),edge:t};case z.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:A(l.get(),e.origin,e.basis2),edge:t}}}function Vt(e,t,i){const a=i.projectToRenderScreen(m(l.get(),e,t),Ge(l.get())),s=i.projectToRenderScreen(A(l.get(),e,t),Ge(l.get()));return Ei(A(a,a,s))}function Bt(e){const t=M(e.basis1),i=M(e.basis2);return Ta*Math.min(t,i)}function We(e){return Bt(e)}function Ze(e){return e.direction[0]!==0&&e.direction[1]!==0}function qa(e,t=Ce.CENTER_ON_ARROW){const i=t===Ce.CENTER_ON_CALLOUT?Ve:0,a=[N(i,0,-mt/2),N(i,0,mt/2)],s=Ja(a,!0),r=(_,v)=>Za(a,_,v),n=r(0,!1),o=r(Va,!0),d=new Ct({color:fa,renderOccluded:C.OccludeAndTransparent}),y=ce(d,[[i,0,0],[i-Ve,0,0]]),p=ce(d,[[i,0,0],[i-Ve,0,0]]);return new kt({view:e,renderObjects:[...n.normal.map(_=>new H(_,U.Unfocused|P)),...o.normal.map(_=>new H(_,U.Unfocused|P)),new H(y,U.Unfocused|P|Ee),...n.focused.map(_=>new H(_,U.Focused|P)),...o.focused.map(_=>new H(_,U.Focused|P)),new H(p,U.Focused|P|Ee)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:Gt,state:P})}function $t(e,t){const i=xi(e,{customStateMask:P,texture:t});return i.state=P,i}function jt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new ti({view:e,attached:!1,color:ie,width:Nt,writeDepthEnabled:!1,renderOccluded:C.OccludeAndTransparent,geometry:[t]})}function Kt(e){return new Aa({view:e,attached:!1,backgroundColor:[...ae],gridColor:zt,gridWidth:4,renderOccluded:C.OccludeAndTransparent})}function Ya(e,t){const i=Ze(t),a=i?[N(1,0,0),N(0,0,0),N(0,1,0)]:[N(1,0,0),N(-1,0,0)],s=$a,r=O=>new gi({color:s,width:O,renderOccluded:C.OccludeAndTransparent}),n=()=>new Ct({color:s,renderOccluded:C.OccludeAndTransparent}),o=i?Ma:ft,d=o*la,y=ft,p=O=>O>1?r(O):n(),_=[new H(ce(p(o),a),U.Unfocused|xe),new H(ce(p(d),a),U.Focused|xe),new H(ce(p(y),a),is)],v=new kt({view:e,renderObjects:_,collisionType:{type:"line",paths:[a]},radius:i?Ea:Ca,...Li});return v.state=xe,v}function Za(e,t,i){const a=new ye({color:wa,cullFace:me.Back,renderOccluded:C.Opaque}),s=new ye({color:va,cullFace:me.Back,renderOccluded:C.Opaque}),r=new ye({color:ma,cullFace:me.Back,renderOccluded:C.Opaque}),n=new ye({color:Pa,transparent:!0,writeDepth:!1,cullFace:me.Front,renderOccluded:C.Transparent}),o=d=>{e=e.slice(0);const y=A(l.get(),e[0],e[1]);D(y,y);const p=A(l.get(),e[e.length-1],e[e.length-2]);if(D(p,p),t>0){const oe=w(X(),p,-t);e[e.length-1]=m(oe,oe,e[e.length-1]);const te=w(X(),y,-t);e[0]=m(te,te,e[0])}const _=d?ca:1,v=Fe*_,O=Gt*_,E=rt(L.get());if(t>0){const oe=v/4,te=se(l.get(),0,oe,0),_e=1+t/oe;ot(E,E,te),Ot(E,E,se(l.get(),_e,_e,_e)),ot(E,E,w(te,te,-1/_e))}const Q=rt(Se()),B=N(0,1,0),b=lt(Se(),ht(ut.get(),B,p));b[12]=e[e.length-1][0],b[13]=e[e.length-1][1],b[14]=e[e.length-1][2],Z(b,b,E);const ge=Xa(ba*(d?ha:1)+t,e,i?n:r);ge.transformation=Q;const j=[ge],ee=at(i?n:a,v,O,24,!1,!1,!0);ee.transformation=b,j.push(ee);const Oe=at(i?n:s,v,O,24,!1,!0,!1);Oe.transformation=b,j.push(Oe);const K=lt(Se(),ht(ut.get(),B,y));return K[12]=e[0][0],K[13]=e[0][1],K[14]=e[0][2],Z(K,K,E),j.push(ee.instantiate({transformation:K})),j.push(Oe.instantiate({transformation:K})),j};return{normal:o(!1),focused:o(!0)}}function Xa(e,t,i){const a=[];for(let r=0;r<12;r++){const n=r/12*2*Math.PI;a.push([Math.cos(n)*e,Math.sin(n)*e])}return _i(i,a,t,[],[],!1)}function Ja(e,t){const i=A(X(),e[e.length-1],e[e.length-2]);if(D(i,i),w(i,i,Fe),m(i,i,e[e.length-1]),t){const a=A(X(),e[0],e[1]);return D(a,a),w(a,a,Fe),m(a,a,e[0]),[a,...e,i]}return[...e,i]}function qt(e,t,i,a=new qe){if(g(e))return null;const{renderCoordsHelper:s}=t,r=s.fromRenderCoords(e.origin,t.spatialReference);if(g(r))return null;const n=Ci(r,i);if(g(n))return null;a.position=n;const o=2*M(e.basis1),d=2*M(e.basis2),y=Dt.renderUnitScaleFactor(t.spatialReference,i);a.width=o*y,a.height=d*y;const p=s.worldUpAtPosition(e.origin,l.get());return a.tilt=bi(Xe(e,p)),a.heading=s.headingAtPosition(e.origin,e.basis1)-90,a}function Xe(e,t){return Di(t,e.basis2,e.basis1)+re}function Qa(e,t,i,a,s,r,n=$()){return r.toRenderCoords(e,n.origin)?(r.worldBasisAtPosition(n.origin,dt.X,n.basis1),r.worldBasisAtPosition(n.origin,dt.Y,n.basis2),Lt(n.basis2,n.basis1,n.origin,n.plane),ze(n,-Te(t),Me(n),n),ze(n,Te(i),n.basis1,n),w(n.basis1,n.basis1,a/2),w(n.basis2,n.basis2,s/2),pi(n),n):(Et.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function es(e,t){if(g(e)||g(e.position))return null;const i=ii(e.position,t.spatialReference,t.elevationProvider);if(g(i))return null;const a=Dt.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,r=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:r}}function ts(e,t,i,a=$()){if(g(e))return null;const s=Qa(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return!i.tiltEnabled&&h(s)&&Na(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(z||(z={}));const P=De.Custom1;var ne,T;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(ne||(ne={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(T||(T={}));const Ee=De.Custom2,Pe=xt(),re=Math.PI/2,xe=De.Custom1,is=De.Custom2;var Ce;function as(e){const t=e.type==="building-scene-3d"?e:null;return h(t)}(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ce||(Ce={}));function ss(e){switch(e.type){case"building-scene":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return sa(e.type),!1}}const Yt="esri.views.3d.analysis.Slice.SliceController",Le=Et.getLogger(Yt);let q=class extends je{constructor(e){super(e),this._handles=new $e,this._internalChange=!1,this._currentSlicePlane=null}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof st||t instanceof fi)?t instanceof st&&ss(t)?(Le.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(Le.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),rs(this.view,this),this._handles.add([I(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),I(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),I(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),I(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([I(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),os(this.view,this),this._handles.destroy(),this.set("view",null)}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(as).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(g(t)&&g(e)||h(t)&&h(e)&&e.equals(t))return;let i=null,a=null;if(h(e)&&h(e.position)){const s=e.position.spatialReference,r=es(e,this.view);g(r)&&ai(this.analysis,s,Le),i=ts(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},$()),h(i)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=qt(e,this.view,this.view.spatialReference,new qe);let i=null;h(t)&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(Ae)return;const e=Zt(this.view);if(e)if(this.analysisViewData.active)h(e.activeController)&&e.activeController!==this?(Ae=!0,e.activeController.analysisViewData.active=!1,Ae=!1):h(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(h(e.activeController)&&e.activeController!==this)return;h(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){ns(this.view)}_updateLayerViews(){const e=h(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};c([u()],q.prototype,"view",void 0),c([u()],q.prototype,"analysis",void 0),c([u()],q.prototype,"analysisViewData",void 0),c([u()],q.prototype,"_allLayerAndSubLayerViews",null),q=c([de(Yt)],q);const Y=new Map;let Ae=!1;function ns(e){var i;const t=(i=Zt(e))==null?void 0:i.activeController;h(t)&&h(t.analysisViewData.plane)&&t.analysisViewData.visible?e.slicePlane=t.analysisViewData.plane:e.slicePlane=null}function rs(e,t){var i;Y.has(e)||Y.set(e,{all:[],activeController:null}),(i=Y.get(e))==null||i.all.push(t)}function Zt(e){return Y.get(e)}function os(e,t){if(!Y.has(e))throw new Error("view expected in global slice register");const i=Y.get(e),a=(i==null?void 0:i.all.lastIndexOf(t))??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&Y.delete(e)}var Be;let f=Be=class extends Ai{constructor(e){super(e),this._clock=na,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new $e,this._viewHandles=new $e,this._frameTask=null,this._pointerMoveTimerMs=da,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=$(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Vi(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=yi(e.view.state.viewingMode),this._intersector.options.store=wi.MIN}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._rotateHeadingImage=ra(this.view.toolViewManager.textures),this._rotateTiltImage=oa(this.view.toolViewManager.textures);const e=i=>{this._updateManipulatorsInteractive(i),i.grabbing||(h(this.analysisViewData.plane)&&V(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=qa(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),e(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=$t(this.view,this._rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),e(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=$t(this.view,this._rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),e(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=Ya(this.view,i);return s.events.on("grab-changed",r=>{this._onResizeGrab(r,a),e(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Kt(this.view),this._previewPlaneOutlineVisualElement=jt(this.view),this._previewPlaneOutlineVisualElement.width=Ht,this._handles.add(I(()=>this.analysisViewData.plane,()=>this._updateManipulators(),oi));const t=I(()=>this.state,i=>{i==="sliced"&&this.finishToolCreation()},He);this._handles.add([t,I(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._rotateHeadingImage=Qe(this._rotateHeadingImage),this._rotateTiltImage=Qe(this._rotateTiltImage),this._handles=W(this._handles),this._viewHandles=W(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=W(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=W(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":h(this._creatingPointerId)?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=h(e)&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return h(this.inputState)&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){g(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){g(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!ke(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!ke(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!ke(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&h(t)&&t.type==="shift"){const i=he(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(he(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&h(this.analysisViewData.plane)){const t=he(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),V(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=he(e),i=$();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(V(i,this._startPlane),this.analysis.shape=qt(i,this.view,this.view.spatialReference,new qe),e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=Mt(a,e.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(he(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===Re||e.key===Ie)&&(this._activeKeyModifiers[e.key]=!0,h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==Re&&e.key!==Ie||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||g(this.analysisViewData.plane)||!e.screenPoint)return;const t=this._calculatePickRay(e.screenPoint);V(this.analysisViewData.plane,this._startPlane),this.inputState=Mt(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(g(s)||s.type!=="shift")return;const r=h(this.analysisViewData.plane)?V(this.analysisViewData.plane,$()):null;i.next(fe(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{h(r)&&this._updateBoundedPlane(r)})})}_shiftDragAdjustSensitivity(e){return t=>{if(g(this.analysisViewData.plane))return null;const i=.001,a=Math.min((1-Math.abs(x(Me(this.analysisViewData.plane),t.ray.direction)/M(t.ray.direction)))/i,1),s=-pt(this._startPlane.plane,t.renderEnd),r=-pt(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-r,t}}_shiftDragUpdatePlane(e){return()=>{if(g(this.analysisViewData.plane))return;const t=R(l.get(),this._startPlane.origin),i=R(l.get(),Me(this._startPlane));w(i,i,-e.depth),m(i,i,t);const a=Ne(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,$());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||g(this.analysisViewData.plane)||!e.screenPoint)return;const t=bt(this.analysisViewData.plane,this.view.renderCoordsHelper,ne.HEADING,Ue()),i=this._calculatePickRay(e.screenPoint),a=X();be(t,i,a)&&(V(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(g(s)||s.type!=="rotate")return;const r=h(this.analysisViewData.plane)?V(this.analysisViewData.plane,$()):null;i.next(fe(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(r)&&this._updateBoundedPlane(r)})})}_onRotateTiltGrab(e){if(e.action!=="start"||g(this.analysisViewData.plane)||!e.screenPoint)return;const t=bt(this.analysisViewData.plane,this.view.renderCoordsHelper,ne.TILT,Ue()),i=this._calculatePickRay(e.screenPoint),a=X();be(t,i,a)&&(V(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(g(s)||s.type!=="rotate")return;const r=h(this.analysisViewData.plane)?V(this.analysisViewData.plane,$()):null;i.next(fe(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(r)&&this._updateBoundedPlane(r)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(g(this.analysisViewData.plane))return null;const i=Si(e.rotatePlane),a=ki(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(g(this.analysisViewData.plane))return;const t=Ti(L.get(),e.rotateAngle,e.rotateAxis);if(g(t))return;const i=ct(l.get(),this._startPlane.basis1,t),a=ct(l.get(),this._startPlane.basis2,t),s=Ne(this.analysisViewData.plane.origin,i,a,$());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||g(this.analysisViewData.plane)||!e.screenPoint)return;const i=this._calculatePickRay(e.screenPoint),a=l.get();be(this.analysisViewData.plane.plane,i,a)&&(V(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Rt(a)})}_createResizeDragPipeline(e){return we(e,(t,i,a)=>{const s=this.inputState;if(g(s)||s.type!=="resize"||g(this.analysisViewData.plane))return;const r=V(this.analysisViewData.plane,$());i.next(fe(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(r)})})}_resizeDragUpdatePlane(e){return t=>{if(g(this.analysisViewData.plane))return;const i=this._resizeHandles[e.activeHandleIdx],a=za(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,V(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(!h(t))throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,g(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=h(i)?i:$();if(i=h(i)?V(i,ls):null,this._pickPlane(e,!0,t,a)){const s=ga;let r=!1;h(i)&&(r=x(i.plane,a.plane)<s||x(D(l.get(),i.basis1),D(l.get(),a.basis1))<s),r&&(this._previewPlaneOpacity=0),this._previewPlane=a}}h(this._previewPlane)&&g(this._frameTask)&&this._previewPlaneOpacity===0?this._frameTask=Jt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*_a),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):g(this._previewPlane)&&h(this._frameTask)?this._removeFrameTask():h(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=et(this._frameTask)}_calculatePickRay(e){const t=xt(),i=nt(e,hs);return vi(this.view.state.camera,i,t),D(t.direction,t.direction),t}_pickMinResult(e){const t=nt(e,Oi.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),r=l.get();if(!s.getIntersectionPoint(r))return!1;const n=s.getTransformedNormal(l.get()),o=this.view.state.camera;x(n,o.viewForward)>0&&w(n,n,-1);const d=Ga(r,o),y=(t?1:-1)*d*ua,p=w(l.get(),n,y);m(p,p,r);const _=this.analysis.tiltEnabled?T.TILTED:T.HORIZONTAL_OR_VERTICAL,v=i[Re]?T.VERTICAL:i[Ie]?T.HORIZONTAL:_;return ka(p,n,d,d,o,v,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=et(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=P,this.rotateHeadingManipulator.state|=P,this.rotateTiltManipulator.state|=P,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~P,this.rotateHeadingManipulator.state&=~P,this.rotateTiltManipulator.state&=~P},this._pointerMoveTimerMs)}_updateManipulators(){if(Be.disableEngineLayers)return;let e,t=!1;if(h(this.analysisViewData.plane))e=this.analysisViewData.plane,t=!1;else{if(!h(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(n=>n.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=Wt(e,L.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(n=>n.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(n=>n.available=!0),Fa(this.shiftManipulator,i,e,this.view.state.camera),ja(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),Ka(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((n,o)=>Ba(n,this._resizeHandles[o],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=se(l.get(),M(e.basis1),M(e.basis2),1),s=It(L.get(),a),r=Z(s,i,s);this._previewPlaneOutlineVisualElement.transform=r,this._previewPlaneGridVisualElement.transform=r,this._updateMaterials()}_updateMaterials(){const e=[ie[0],ie[1],ie[2],ie[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=e;const t=[ae[0],ae[1],ae[2],ae[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=i}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function Mt(e,t,i,a){const s=Ua(i,Me(a),e.direction,Ue()),r=X();return be(s,e,r)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:r}:null}function ke(e){return e.pointerType!=="mouse"||e.button===0}f.disableEngineLayers=!1,c([u()],f.prototype,"_clock",void 0),c([u({constructOnly:!0})],f.prototype,"view",void 0),c([u()],f.prototype,"analysisViewData",void 0),c([u({readOnly:!0})],f.prototype,"state",null),c([u({readOnly:!0})],f.prototype,"cursor",null),c([u()],f.prototype,"analysis",null),c([u()],f.prototype,"removeIncompleteOnCancel",void 0),c([u({readOnly:!0})],f.prototype,"layersMode",void 0),c([u({value:null})],f.prototype,"inputState",null),c([u()],f.prototype,"_isPlacingSlicePlane",null),c([u()],f.prototype,"_creatingPointerId",null),f=Be=c([de("esri.views.3d.analysis.Slice.SliceTool")],f);const ls=$(),hs=$i(),cs=f;let G=class extends je{constructor(e){super(e),this._handles=new $e,this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(g(e))throw new Error("expected internal object to be valid");this._gridVisualElement=Kt(this.view),this._outlineVisualElement=jt(this.view),this._handles.add([I(()=>({visible:h(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),He),I(()=>e.plane,t=>this._updatePlane(t),He)],"internal")}destroy(){this._handles.destroy(),this._gridVisualElement=W(this._gridVisualElement),this._outlineVisualElement=W(this._outlineVisualElement),this.set("view",null)}_updatePlane(e){if(g(e))return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=se(l.get(),M(e.basis1),M(e.basis2),1),i=It(L.get(),t),a=Wt(e,L.get()),s=Z(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=ie,this._outlineVisualElement.width=i?Ht:Nt,this._outlineVisualElement.stipplePattern=t?null:mi(5),this._gridVisualElement.backgroundColor=ae,this._gridVisualElement.gridColor=a?zt:Ii,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};c([u()],G.prototype,"view",void 0),c([u()],G.prototype,"analysis",void 0),c([u()],G.prototype,"analysisViewData",void 0),c([u()],G.prototype,"showGrid",void 0),c([u()],G.prototype,"preview",void 0),G=c([de("esri.views.3d.analysis.Slice.SliceVisualization")],G);let S=class extends si(je){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new G({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new q({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(Hi(this,cs))}destroy(){Ni(this),this.analysisVisualization=W(this.analysisVisualization),this.analysisController=W(this.analysisController)}get showGrid(){var e;return((e=this.analysisVisualization)==null?void 0:e.showGrid)??!1}set showGrid(e){this.analysisVisualization&&(this.analysisVisualization.showGrid=e)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:Tt(this.tool)}}};c([u({readOnly:!0})],S.prototype,"type",void 0),c([u({constructOnly:!0,nonNullable:!0})],S.prototype,"analysis",void 0),c([u()],S.prototype,"tool",void 0),c([u()],S.prototype,"plane",void 0),c([u()],S.prototype,"active",void 0),c([u()],S.prototype,"showGrid",null),c([u()],S.prototype,"editable",null),S=c([de("esri.views.3d.analysis.SliceAnalysisView3D")],S);const ds=S,sn=Object.freeze(Object.defineProperty({__proto__:null,default:ds},Symbol.toStringTag,{value:"Module"}));export{sn as S,Oa as t};
